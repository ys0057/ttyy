<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompt Generator V9.5 - Optimized</title>
    <style>
        /* --- CSS 視覺與層次優化 --- */
        :root {
            --primary: #2563eb;
            --primary-gradient: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --success: #10b981;
        }

        body { 
            font-family: 'Inter', 'Segoe UI', 'Microsoft JhengHei', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 20px; 
            margin: 0; 
            line-height: 1.5;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        header { 
            margin-bottom: 25px; 
            border-bottom: 2px solid var(--primary); 
            padding-bottom: 15px; 
        }

        .header-main { display: flex; justify-content: space-between; align-items: center; }

        .lang-btn { 
            padding: 6px 14px; border: 1px solid var(--primary); 
            background: white; cursor: pointer; border-radius: 6px; 
            font-weight: 600; color: var(--primary); transition: 0.2s; 
        }
        .lang-btn.active { background: var(--primary); color: white; }

        .info-banner { 
            background: white; 
            border-radius: 12px; 
            padding: 15px 20px; 
            margin-bottom: 25px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary);
        }

        .top-controls { 
            display: grid; 
            grid-template-columns: auto 1fr; 
            gap: 20px; 
            margin-bottom: 30px; 
            align-items: center;
        }

        .control-group { 
            background: white; padding: 12px 20px; border-radius: 10px; 
            border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; 
        }
        
        .success-heavy { 
            background: var(--primary-gradient); 
            color: white; 
            font-size: 1.1rem; 
            padding: 12px; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: transform 0.2s;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        .success-heavy:hover { transform: translateY(-2px); opacity: 0.9; }

        .main-layout { display: grid; grid-template-columns: 1fr 420px; gap: 30px; }

        fieldset { 
            border: 1px solid var(--border); 
            border-radius: 16px; 
            padding: 25px; 
            margin-bottom: 25px; 
            background: white; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            transition: all 0.3s ease;
        }
        fieldset:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
        .high-priority { border: 2px solid var(--primary); background: #f8faff; }

        legend { font-weight: 800; color: var(--primary); padding: 0 10px; font-size: 1.1rem; }

        .field-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .full-width { grid-column: 1 / -1; }

        .input-unit label { font-size: 0.85rem; font-weight: 700; margin-bottom: 8px; display: block; color: #64748b; }
        .input-unit input { 
            width: 100%; padding: 10px; border: 1.5px solid var(--border); 
            border-radius: 8px; transition: all 0.2s; box-sizing: border-box;
        }
        .input-unit input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        /* 輸出區域固定效果 */
        .output-side { position: sticky; top: 20px; height: fit-content; }
        .output-card { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
        .card-header { padding: 10px 15px; background: #f8fafc; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        
        .code-box { 
            padding: 15px; font-size: 0.9rem; min-height: 50px; 
            white-space: pre-wrap; word-break: break-all;
        }
        .json-box { background: #1e293b; color: #38bdf8; font-family: 'Consolas', monospace; font-size: 0.8rem; }

        .form-footer { display: flex; gap: 15px; margin-top: 10px; }
        .btn-reset { background: #f1f5f9; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; color: #64748b; font-weight: 600; }

        .history-section { max-height: 300px; overflow-y: auto; padding: 10px; background: white; border-radius: 12px; border: 1px solid var(--border); }
        .history-item { padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 0.8rem; transition: background 0.2s; }
        .history-item:hover { background: #f8fafc; }

        @media (max-width: 1100px) { 
            .main-layout { grid-template-columns: 1fr; } 
            .output-side { position: static; } 
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-main">
                <h1>🤖 AI Prompt Generator <span style="font-size: 0.5em; vertical-align: middle; opacity: 0.6;">V9.5</span></h1>
                <div class="lang-switcher">
                    <button class="lang-btn active" onclick="setLanguage('zh')">繁中</button>
                    <button class="lang-btn" onclick="setLanguage('en')">EN</button>
                </div>
            </div>
            <p id="ui-subtitle" style="margin-top: 5px; color: #64748b;">載入中...</p>
        </header>

        <div class="info-banner">
            <p id="ui-usage-tip">💡 填寫下方欄位，右側將即時生成提示詞。</p>
        </div>
        
        <div class="top-controls">
            <div class="control-group">
                <label id="ui-label-num">👥 角色數量:</label>
                <input type="number" id="numSubjects" value="1" min="0" max="5" oninput="renderForm()">
            </div>
            <button class="success-heavy" id="randomizeBtn" onclick="randomizeAll()">✨ 隨機靈感 (Randomize All)</button>
        </div>

        <div class="main-layout">
            <form id="promptForm" oninput="generatePrompt()" onsubmit="event.preventDefault();">
                <fieldset class="high-priority">
                    <legend id="ui-leg-core">🎨 核心視覺 (Core Style)</legend>
                    <div class="field-grid">
                        <div class="input-unit full-width">
                            <label id="ui-label-title">1. 描述你的圖像主題 (Title):</label>
                            <input type="text" id="title" placeholder="例如: 一位在雨中漫步的少女...">
                        </div>
                        <div class="input-unit">
                            <label id="ui-label-genre">2. 藝術風格 (Genre):</label>
                            <input type="text" id="genre" list="list-genre">
                            <datalist id="list-genre"></datalist>
                        </div>
                        <div class="input-unit">
                            <label id="ui-label-vibe">3. 視覺氛圍 (Vibe):</label>
                            <input type="text" id="vibe" list="list-vibe">
                            <datalist id="list-vibe"></datalist>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend id="ui-leg-env">📸 環境與攝影 (Environment)</legend>
                    <div class="field-grid">
                        <div class="input-unit">
                            <label id="ui-label-angle">視角 (Angle):</label>
                            <input type="text" id="angle" list="list-angle"> <datalist id="list-angle"></datalist>
                        </div>
                        <div class="input-unit">
                            <label id="ui-label-location">地點 (Location):</label>
                            <input type="text" id="location" list="list-location"> <datalist id="list-location"></datalist>
                        </div>
                        <div class="input-unit">
                            <label id="ui-label-lighting">光影 (Lighting):</label>
                            <input type="text" id="lighting" list="list-lighting"> <datalist id="list-lighting"></datalist>
                        </div>
                        <div class="input-unit">
                            <label id="ui-label-quality">畫質 (Quality):</label>
                            <input type="text" id="quality" list="list-quality"> <datalist id="list-quality"></datalist>
                        </div>
                    </div>
                </fieldset>

                <div id="subjectsContainer"></div>

                <div class="form-footer">
                    <button type="button" class="btn-reset" onclick="resetAllFields()">🗑️ 清空重製</button>
                </div>
            </form>

            <div class="output-side">
                <div class="output-card">
                    <div class="card-header">
                        <span style="font-weight: bold; color: var(--primary);">English Prompt</span>
                        <button class="lang-btn" style="padding: 2px 8px; font-size: 0.7rem;" onclick="copyText('out-en')">📋 複製</button>
                    </div>
                    <div id="out-en" class="code-box">...</div>
                </div>

                <div class="output-card">
                    <div class="card-header">
                        <span style="font-weight: bold; color: #64748b;">中文結構參考</span>
                    </div>
                    <div id="out-zh" class="code-box" style="color: #64748b; font-size: 0.8rem;">...</div>
                </div>

                <div class="output-card">
                    <div class="card-header">
                        <span style="font-weight: bold; color: #38bdf8;">JSON Data</span>
                    </div>
                    <div id="out-json" class="code-box json-box">{}</div>
                </div>

                <div id="historyList" class="history-section">
                    </div>
            </div>
        </div>
    </div>

    <script>
        /* --- JS 邏輯優化 --- */
        let DICTIONARY = {};
        let UI_LANG = 'zh';
        const SUBJECT_ATTRS = ["gender", "age", "species", "ethnicity", "body", "hairStyle", "hairColor", "outfit", "accessories", "pose", "expression"];

        const UI_TEXT = {
            zh: {
                subtitle: "人像提示詞輔助生成器 - 核心權重優化版",
                usage: "💡 填寫欄位或點擊隨機，右側將即時呈現結果。",
                legSub: "👤 角色設定 Subject",
                labels: {
                    genre: "藝術風格", vibe: "視覺氛圍", gender: "性別", age: "年齡層", 
                    species: "物種", ethnicity: "族裔", hairStyle: "髮型", hairColor: "髮色", 
                    body: "身材", outfit: "服裝", accessories: "配件", pose: "姿勢", 
                    expression: "表情", angle: "視角", location: "地點", lighting: "光影", quality: "畫質"
                }
            },
            en: {
                subtitle: "AI Prompt Helper - Weight Optimized",
                usage: "💡 Fill fields or randomize, results update in real-time.",
                legSub: "👤 Subject",
                labels: {
                    genre: "Style", vibe: "Vibe", gender: "Gender", age: "Age",
                    species: "Species", ethnicity: "Ethnicity", hairStyle: "Hair", hairColor: "Color",
                    body: "Body", outfit: "Outfit", accessories: "Accessories", pose: "Pose", 
                    expression: "Expression", angle: "Angle", location: "Location", lighting: "Lighting", quality: "Quality"
                }
            }
        };

        async function init() {
            try {
                const res = await fetch('data.json');
                DICTIONARY = await res.json();
                setLanguage('zh');
                renderHistory();
            } catch (e) { console.error("Data Load Error", e); }
        }

        function setLanguage(lang) {
            UI_LANG = lang;
            document.getElementById('ui-subtitle').innerText = UI_TEXT[UI_LANG].subtitle;
            document.getElementById('ui-usage-tip').innerText = UI_TEXT[UI_LANG].usage;
            
            // 重新渲染固定欄位的 datalist
            ["genre", "vibe", "angle", "location", "lighting", "quality"].forEach(k => {
                renderDatalist(`list-${k}`, k);
            });
            renderForm();
        }

        function renderDatalist(id, key) {
            const dl = document.getElementById(id);
            if (dl && DICTIONARY[key]) {
                dl.innerHTML = DICTIONARY[key].map(i => `<option value="${i[UI_LANG]}"></option>`).join('');
            }
        }

        function renderForm() {
            const container = document.getElementById('subjectsContainer');
            const num = parseInt(document.getElementById('numSubjects').value) || 0;
            const t = UI_TEXT[UI_LANG];
            
            // 效能優化：使用 DocumentFragment
            const fragment = document.createDocumentFragment();
            for(let i=0; i<num; i++) {
                const fieldset = document.createElement('fieldset');
                fieldset.innerHTML = `<legend>${t.legSub} ${i+1}</legend><div class="field-grid"></div>`;
                const grid = fieldset.querySelector('.field-grid');
                
                SUBJECT_ATTRS.forEach(attr => {
                    const unit = document.createElement('div');
                    unit.className = 'input-unit';
                    unit.innerHTML = `
                        <label>${t.labels[attr] || attr}:</label>
                        <input type="text" id="subject-${i}-${attr}" list="list-s${i}-${attr}">
                        <datalist id="list-s${i}-${attr}"></datalist>
                    `;
                    grid.appendChild(unit);
                    // 異步渲染角色屬性選單
                    setTimeout(() => renderDatalist(`list-s${i}-${attr}`, attr), 0);
                });
                fragment.appendChild(fieldset);
            }
            container.innerHTML = '';
            container.appendChild(fragment);
            generatePrompt();
        }

        function generatePrompt() {
            const getVal = (id) => document.getElementById(id)?.value || "";
            const title = getVal('title');
            const num = parseInt(document.getElementById('numSubjects').value) || 0;

            let subEn = [], subZh = [];
            for(let i=0; i<num; i++){
                let partsE = [], partsZ = [];
                SUBJECT_ATTRS.forEach(a => {
                    const v = getVal(`subject-${i}-${a}`);
                    if(v) {
                        // 比對字典取得英文對應
                        const item = DICTIONARY[a]?.find(x => x.en === v || x.zh === v);
                        partsE.push(item ? item.en : v);
                        partsZ.push(item ? item.zh : v);
                    }
                });
                if(partsE.length) {
                    subEn.push(`(1 ${partsE.join(', ')})`);
                    subZh.push(`角色${i+1}: ${partsZ.join(', ')}`);
                }
            }
            
            const envE = ["location", "angle", "lighting", "quality"].map(k => getVal(k)).filter(v => v).join(', ');
            const en = `${getVal('genre')}, ${title}, ${getVal('vibe')}, ${subEn.join(' and ')}, ${envE}`;
            const zh = `風格: ${getVal('genre')} | 主題: ${title}\n角色: ${subZh.join(' & ')}`;

            document.getElementById('out-en').innerText = en;
            document.getElementById('out-zh').innerText = zh;
            document.getElementById('out-json').innerText = JSON.stringify({ en, zh }, null, 2);
            
            saveHistory(en, zh);
        }

        function randomizeAll() {
            const keys = ["genre", "vibe", "angle", "location", "lighting", "quality"];
            keys.forEach(k => {
                const items = DICTIONARY[k];
                if(items) document.getElementById(k).value = items[Math.floor(Math.random()*items.length)][UI_LANG];
            });
            const num = parseInt(document.getElementById('numSubjects').value);
            for(let i=0; i<num; i++){
                SUBJECT_ATTRS.forEach(a => {
                    const items = DICTIONARY[a];
                    if(items) document.getElementById(`subject-${i}-${a}`).value = items[Math.floor(Math.random()*items.length)][UI_LANG];
                });
            }
            generatePrompt();
        }

        function copyText(id) {
            const text = document.getElementById(id).innerText;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector(`button[onclick="copyText('${id}')"]`);
                const originalText = btn.innerText;
                btn.innerText = "✅ 已複製";
                setTimeout(() => btn.innerText = originalText, 1500);
            });
        }

        function resetAllFields() {
            if(confirm("確定要清空所有欄位嗎？")) {
                document.getElementById('promptForm').reset();
                generatePrompt();
            }
        }

        // 歷史紀錄功能
        function saveHistory(en, zh) {
            if (!en || en.length < 10) return;
            let history = JSON.parse(localStorage.getItem('app_history') || '[]');
            if (history.length > 0 && history[0].en === en) return;
            history.unshift({ en, zh, time: new Date().toLocaleTimeString() });
            localStorage.setItem('app_history', JSON.stringify(history.slice(0, 10)));
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            const history = JSON.parse(localStorage.getItem('app_history') || '[]');
            if (history.length === 0) {
                list.innerHTML = '<p style="padding:10px; color:#94a3b8; font-size:0.8rem;">尚無歷史紀錄</p>';
                return;
            }
            list.innerHTML = history.map(item => `
                <div class="history-item" onclick="loadHistoryItem('${item.en.replace(/'/g, "\\'")}')">
                    <div style="color: var(--primary); font-weight: bold; margin-bottom: 4px;">${item.time}</div>
                    <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; opacity: 0.7;">${item.en}</div>
                </div>
            `).join('');
        }

        function loadHistoryItem(en) {
            const history = JSON.parse(localStorage.getItem('app_history') || '[]');
            const item = history.find(h => h.en === en);
            if (item) {
                document.getElementById('out-en').innerText = item.en;
                document.getElementById('out-zh').innerText = item.zh;
                alert("已回載該筆提示詞至輸出區");
            }
        }

        window.onload = init;
    </script>
</body>
</html>